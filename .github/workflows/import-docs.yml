# .github/workflows/import-docs.yml
name: Import Documentation to src/app

on:
  workflow_call:
    inputs:
      source-repo:
        description: 'Source repository with MDX files'
        required: true
        type: string
      source-path:
        description: 'Path to MDX files in source repo'
        required: false
        default: 'docs'
        type: string
      clean-target:
        description: 'Clean target directory before copy'
        required: false
        default: false
        type: boolean

jobs:
  import-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docs repository
        uses: actions/checkout@v4
        with:
          path: docs-repo
          fetch-depth: 0

      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.source-repo }}
          path: source-repo
          sparse-checkout: |
            ${{ inputs.source-path }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs-repo/package-lock.json

      - name: Clean target directory (if requested)
        if: ${{ inputs.clean-target == 'true' }}
        run: |
          cd docs-repo/src/app
          # Remove only MDX-related directories, keep core files
          find . -maxdepth 1 -type d ! -name '.' ! -name 'api' ! -name 'lib' ! -path './.*' -exec rm -rf {} + 2>/dev/null || true
          find . -name '*.mdx' -delete
          find . -name '*.md' -delete

      - name: Copy MDX files to src/app
        run: |
          # Create source and target paths
          SOURCE_DIR="source-repo/${{ inputs.source-path }}"
          TARGET_DIR="docs-repo/src/app"

          # Check if source directory exists
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ Source directory $SOURCE_DIR not found!"
            exit 1
          fi

          echo "ðŸ“ Copying from $SOURCE_DIR to $TARGET_DIR"

          # Copy all files and directories from source to target
          cp -r "$SOURCE_DIR"/* "$TARGET_DIR/" 2>/dev/null || true

          # Remove any non-MDX/MD files to keep src/app clean
          find "$TARGET_DIR" -type f ! -name "*.mdx" ! -name "*.md" ! -name "*.tsx" ! -name "*.ts" ! -name "layout.tsx" ! -name "sitemap.ts" ! -name "robots.ts" ! -name "not-found.tsx" ! -name "manifest.ts" -delete

          echo "âœ… Files copied successfully"

      - name: Validate structure
        run: |
          cd docs-repo/src/app
          echo "ðŸ“‹ Current structure:"
          find . -name "*.mdx" -o -name "*.md" | head -20
          echo "..."
          MDX_COUNT=$(find . -name "*.mdx" -o -name "*.md" | wc -l)
          echo "ðŸ“Š Total MDX/MD files: $MDX_COUNT"

      - name: Install dependencies
        run: cd docs-repo && npm ci

      - name: Build documentation
        run: cd docs-repo && npm run build

      - name: Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs-repo/out

  deploy:
    runs-on: ubuntu-latest
    needs: import-and-build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pages-artifact
          path: ./out

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
