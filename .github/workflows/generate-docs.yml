# .github/workflows/generate-docs.yml
name: Generate Documentation

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'src/docs/**'
      - '.github/workflows/generate-docs.yml'
  workflow_dispatch:
    inputs:
      clean-build:
        description: 'Clean existing docs before build'
        required: false
        default: false
        type: boolean

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Clean target directory (if requested)
        if: ${{ github.event.inputs.clean-build == 'true' }}
        run: |
          cd src/app
          # Remove only MDX-related directories, keep core files
          find . -maxdepth 1 -type d ! -name '.' ! -name 'api' ! -name 'lib' ! -path './.*' -exec rm -rf {} + 2>/dev/null || true
          find . -name '*.mdx' -delete
          find . -name '*.md' -delete

      - name: Copy MDX files to src/app
        run: |
          # Create source and target paths
          SOURCE_DIR="docs"
          TARGET_DIR="src/app"

          # Check if source directory exists
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ Source directory $SOURCE_DIR not found!"
            exit 1
          fi

          echo "ðŸ“ Copying from $SOURCE_DIR to $TARGET_DIR"

          # Copy all files and directories from source to target
          cp -r "$SOURCE_DIR"/* "$TARGET_DIR/" 2>/dev/null || true

          # Remove any non-MDX/MD files to keep src/app clean
          find "$TARGET_DIR" -type f ! -name "*.mdx" ! -name "*.md" ! -name "*.tsx" ! -name "*.ts" ! -name "layout.tsx" ! -name "sitemap.ts" ! -name "robots.ts" ! -name "not-found.tsx" ! -name "manifest.ts" -delete

          echo "âœ… Files copied successfully"

      - name: Validate structure
        run: |
          cd src/app
          echo "ðŸ“‹ Current structure:"
          find . -name "*.mdx" -o -name "*.md" | head -20
          echo "..."
          MDX_COUNT=$(find . -name "*.mdx" -o -name "*.md" | wc -l)
          echo "ðŸ“Š Total MDX/MD files: $MDX_COUNT"

      - name: Install dependencies
        run: npm ci

      - name: Build documentation
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: out

  deploy:
    runs-on: ubuntu-latest
    needs: build-docs
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pages-artifact
          path: ./out

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
